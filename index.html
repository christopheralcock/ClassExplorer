<head>
	<style>
		body {
			margin: auto;
		}

		table {
			width: 100%;
		}
	</style>
</head>

<body>

	<h1 id="title">Member count and overlap for class</h1>
	<h2>Click rows to see breakdowns for other classes.</h2>

	<div id="explanation">
		What is this? Click for explanation
	</div>

	<div id="wait">
		Please wait - fetching data
		<img src="http://textfiles.com/underconstruction/CoColosseumField5989Construction.gif">
	</div>

	<table id="classes">
		<tr>
			<th id="classURI"></th>
			<th id="countHeader"></th>
		</tr>
	</table>

	<script>
		var url = new URL(window.location.href);

		if (!url.searchParams.get("class")) {
			url.searchParams.set('class', encodeURI("https://id.parliament.uk/schema/Group"));
			window.location.replace(url);
		}
		var classToExplore = url.searchParams.get("class");
		var dataUrl = new URL("https://api.parliament.uk/query/class_count.json");
		dataUrl.searchParams.set('class', classToExplore);

		var title = document.getElementById("title");
		title.innerText = "Member count and overlap for " + decodeURI(classToExplore);

		var explanation = document.getElementById("explanation");
		explanation.onclick = function () {
			explanation.innerText = "The UK Parliamentary Digital Service is creating a new dataservice, driven by the needs of beta.parliament.uk.  Underlying this database is a graph triple store.  An important concept in graph databases is that items can belong to many classes simultaneously, allowing us to categorise things by their behaviour and relations rather than rigid table membership or similar.  This tool allows us in the Data & Search team to express these classes by showing how many members they have in common with other classes, allowing users to understand which classes are closely related, by the ordering of the graph, and which have lots of data available for querying, based on the count itself"
		}

		fetch(dataUrl)
			.then(function (response) {
				return response.json();
			})
			.then(function (json) {
				hideWait();
				setTableHeaders();
				json.results.bindings.forEach(
					function (element) {
						addRow(element);
					}
				);
			})

		var hideWait = function () {
			var wait = document.getElementById("wait");
			wait.innerHTML = null;
		}

		var setTableHeaders = function () {
			var classURI = document.getElementById("classURI");
			classURI.innerText = "Class URI";
			var countHeader = document.getElementById("countHeader");
			countHeader.innerText = "Count of members in common with " + decodeURI(classToExplore);
		}

		var addRow = function (element) {
			var row;
			var table = document.getElementById("classes");
			element.otherClass.value == classToExplore ? row = table.insertRow(1) : row = table.insertRow(-1);
			var leftCell = row.insertCell(0);
			url = new URL(window.location.href);
			highlighting(row);
			var leftLink = document.createElement("a");
			leftLink.innerText = element.otherClass.value;
			url.searchParams.set('class', encodeURI(element.otherClass.value));
			leftLink.setAttribute("href", url.toString());
			leftCell.appendChild(leftLink);
			var rightCell = row.insertCell(1);
			rightCell.innerHTML = element.count.value;
		}

		var highlighting = function (item) {
			item.onmouseover = function () { item.style.backgroundColor = "Aquamarine" };
			item.onmouseout = function () { item.style.backgroundColor = "white" };
		}
	</script>
</body>
